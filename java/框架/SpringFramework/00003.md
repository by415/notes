### Beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸæ­¥éª¤
![image-BeanLife](../../demo/picture/BeanLife.png)

#### Beançš„ç”Ÿæˆè¿‡ç¨‹

##### ç”ŸæˆBeanDefinition

Springå¯åŠ¨çš„æ—¶å€™ä¼šè¿›è¡Œæ‰«æï¼Œä¼šå…ˆè°ƒç”¨

```java
Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);
```

æ‹¿åˆ°æ‰€æŒ‡å®šçš„åŒ…è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶èµ„æºï¼ˆ******.classæ–‡ä»¶ï¼‰

ç„¶åä¼šéå†æ¯ä¸ªResourceï¼Œä¸ºæ¯ä¸ªResourceç”Ÿæˆä¸€ä¸ªMetadataReaderå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š

1. è·å–å¯¹åº”çš„Resourceèµ„æº
2. è·å–Resourceå¯¹åº”çš„classçš„å…ƒæ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„åå­—ã€æ˜¯ä¸æ˜¯æ¥å£ã€æ˜¯ä¸æ˜¯ä¸€ä¸ªæ³¨è§£ã€æ˜¯ä¸æ˜¯æŠ½è±¡ç±»ã€æœ‰æ²¡æœ‰çˆ¶ç±»ï¼Œçˆ¶ç±»çš„åå­—ï¼Œæ‰€å®ç°çš„æ‰€æœ‰æ¥å£çš„åå­—ï¼Œå†…éƒ¨ç±»çš„ç±»åç­‰ç­‰ã€‚
3. è·å–Resourceå¯¹åº”çš„classä¸Šçš„æ³¨è§£ä¿¡æ¯ï¼Œå½“å‰ç±»ä¸Šæœ‰å“ªäº›æ³¨è§£ï¼Œå½“å‰ç±»ä¸­æœ‰å“ªäº›æ–¹æ³•ä¸Šæœ‰æ³¨è§£

åœ¨ç”ŸæˆMetadataReaderå¯¹è±¡æ—¶ï¼Œä¼šåˆ©ç”¨**ASM**æŠ€æœ¯è§£æclassæ–‡ä»¶ï¼Œå¾—åˆ°ç±»çš„å…ƒæ•°æ®é›†ä¿¡æ¯åˆæ³¨è§£ä¿¡æ¯ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šåˆ©ç”¨ClassLoaderå»åŠ è½½æ³¨è§£ç±»ï¼ˆ**ClassUtils.getDefaultClassLoader()æ‰€è·å¾—çš„ç±»åŠ è½½å™¨**ï¼‰ï¼Œä½†æ˜¯ä¸ä¼šåŠ è½½æœ¬ç±»ã€‚

æœ‰äº†MetadataReaderå¯¹è±¡ï¼Œå°±ç›¸å½“äºæœ‰äº†å½“å‰ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½†æ˜¯å½“å‰ç±»å¹¶æ²¡æœ‰åŠ è½½ï¼Œä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ï¼ŒçœŸæ­£åœ¨ç”¨åˆ°è¿™ä¸ªç±»çš„æ—¶å€™æ‰åŠ è½½ã€‚

ç„¶ååˆ©ç”¨MetadataReaderå¯¹è±¡ç”Ÿæˆä¸€ä¸ªScannedGenericBeanDefinitionå¯¹è±¡ï¼Œ**æ³¨æ„æ­¤æ—¶çš„BeanDefinitionå¯¹è±¡ä¸­çš„beanClasså±æ€§å­˜å‚¨çš„æ˜¯å½“å‰ç±»çš„åå­—ï¼Œè€Œä¸æ˜¯classå¯¹è±¡**ã€‚ï¼ˆbeanClasså±æ€§çš„ç±»å‹æ˜¯Objectï¼Œå®ƒå³å¯ä»¥å­˜å‚¨ç±»çš„åå­—ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨classå¯¹è±¡ï¼‰

##### åˆå¹¶BeanDefinition

å¦‚æœæŸä¸ªBeanDefinitionå­˜åœ¨çˆ¶BeanDefinitionï¼Œé‚£ä¹ˆåˆ™è¦è¿›è¡Œåˆå¹¶ï¼ˆGenericBeanDefinitionï¼ŒRootBeanDefinitionï¼‰ï¼ŒBDæœ‰ä¸ªå±æ€§ï¼ˆabstract="false" ï¼‰ä»£è¡¨ä¼šä¸ä¼šè¢«å®ä¾‹åŒ–ä¸ºBean,(parent="parent")ä»£è¡¨çš„æ˜¯å¦å­˜åœ¨çˆ¶BD,åˆå¹¶çš„æ—¶å€™æ˜¯å­BDçš„å±æ€§è¦†ç›–æ‰çˆ¶BDã€‚

##### åŠ è½½ç±»

æœ‰äº†BeanDefinitionä¹‹åï¼Œåç»­å°±ä¼šåŸºäºBeanDefinitionå»åˆ›å»ºBeanï¼Œè€Œåˆ›å»ºBeanå°±å¿…é¡»å®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œå®ä¾‹åŒ–å°±å¿…é¡»å…ˆåŠ è½½å½“å‰BeanDefinitionæ‰€å¯¹åº”çš„classï¼Œåœ¨AbstractAutowireCapableBeanFactoryç±»çš„createBean()æ–¹æ³•ä¸­ï¼Œä¸€å¼€å§‹å°±ä¼šè°ƒç”¨ï¼š

```java
Class<?> resolvedClass = resolveBeanClass(mbd, beanName);
```

è¿™ä¸ªæ–¹æ³•å°±æ˜¯åŠ è½½ç±»çš„ï¼Œå®ƒçš„å®ç°æ˜¯ï¼š

```java
if (mbd.hasBeanClass()) {
    return mbd.getBeanClass();
}
if (System.getSecurityManager() != null) {
    return AccessController.doPrivileged((PrivilegedExceptionAction<Class<?>>) () ->
        doResolveBeanClass(mbd, typesToMatch), getAccessControlContext());
    }
else {
    return doResolveBeanClass(mbd, typesToMatch);
}
```

```java
public boolean hasBeanClass() {
    return (this.beanClass instanceof Class);
}
```

å¦‚æœbeanClasså±æ€§çš„ç±»å‹æ˜¯Classï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¼šæ ¹æ®ç±»åè¿›è¡ŒåŠ è½½ï¼ˆdoResolveBeanClassæ–¹æ³•æ‰€åšçš„äº‹æƒ…ï¼‰

ä¼šåˆ©ç”¨BeanFactoryæ‰€è®¾ç½®çš„ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é»˜è®¤ä½¿ç”¨**ClassUtils.getDefaultClassLoader()**æ‰€è¿”å›çš„ç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚

**ClassUtils.getDefaultClassLoader()**

1. ä¼˜å…ˆè·å–å½“å‰çº¿ç¨‹ä¸­çš„ClassLoader

2. å¦‚æœä¸ºç©ºï¼Œåˆ™è·å–åŠ è½½ClassUtilsç±»çš„ç±»åŠ è½½å™¨ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œå°±æ˜¯AppClassLoaderï¼Œä½†æ˜¯å¦‚æœæ˜¯åœ¨Tomcatä¸­è¿è¡Œï¼Œé‚£ä¹ˆåˆ™ä¼šæ˜¯Tomcatä¸­ä¸ºæ¯ä¸ªåº”ç”¨æ‰€åˆ›å»ºçš„WebappClassLoaderï¼‰

3. å¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™æ˜¯bootstrapç±»åŠ è½½å™¨åŠ è½½çš„ClassUtilsç±»ï¼Œé‚£åˆ™è·å–ç³»ç»Ÿç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½

##### å®ä¾‹åŒ–å‰

å…è®¸ç¬¬ä¸‰æ–¹å¯ä»¥ä¸æŒ‰ç…§Springçš„æ­£å¸¸æµç¨‹æ¥åˆ›å»ºä¸€ä¸ªBeanï¼Œå¯ä»¥åˆ©ç”¨InstantiationAwareBeanPostProcessorçš„postProcessBeforeInstantiationæ–¹æ³•æ¥æå‰è¿”å›ä¸€ä¸ªBeanå¯¹è±¡ï¼Œç›´æ¥ç»“æŸBeançš„ç”Ÿå‘½å‘¨æœŸ

##### æ¨æ–­æ„é€ æ–¹æ³•

åç»­å•ç‹¬æ‹¿å‡ºæ¥çœ‹

##### å®ä¾‹åŒ–

æ„é€ æ–¹æ³•åå°„å¾—åˆ°ä¸€ä¸ªå®ä¾‹

##### BeanDefinitionçš„åç½®å¤„ç†

```java
for (BeanPostProcessor bp : getBeanPostProcessors()) {
    if (bp instanceof MergedBeanDefinitionPostProcessor) {
        MergedBeanDefinitionPostProcessor bdp = (MergedBeanDefinitionPostProcessor) bp;
        bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);
    }
}
```

è¿™é‡Œå¯ä»¥å¤„ç†BeanDefinitionï¼Œä½†æ˜¯æ­¤æ—¶å®ä¾‹å¯¹è±¡å·²ç»ç”Ÿæˆå¥½äº†ï¼Œæ‰€ä»¥ä¿®æ”¹beanClasså·²ç»æ²¡ç”¨äº†ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹PropertyValuesï¼Œæ¯”å¦‚

```java
@Component
public class LubanMergedBeanDefinitionPostProcessor implements MergedBeanDefinitionPostProcessor {

    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {
        if (beanName.equals("userService")) {
            beanDefinition.setBeanClass(User.class); // æ²¡ç”¨
            beanDefinition.getPropertyValues().add("name","xxx");
        }
    }
}
```

##### å¡«å……å±æ€§

å•ç‹¬å†çœ‹

##### æ‰§è¡ŒAware

1. ((BeanNameAware) bean).setBeanName(beanName);
2. ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);
3. ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.**this**);

##### åˆå§‹åŒ–å‰

```java
for (BeanPostProcessor processor : getBeanPostProcessors()) {
    Object current = processor.postProcessBeforeInitialization(result, beanName);
    if (current == null) {
        return result;
    }
    result = current;
}
```

##### åˆå§‹åŒ–

1. ((InitializingBean) bean).afterPropertiesSet();
2. æ‰§è¡ŒBeanDefinitionä¸­æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•

##### åˆå§‹åŒ–å

```java
for (BeanPostProcessor processor : getBeanPostProcessors()) {
    Object current = processor.postProcessAfterInitialization(result, beanName);
    if (current == null) {
        return result;
    }
    result = current;
}
```

### Beané”€æ¯çš„ç”Ÿå‘½å‘¨æœŸæ­¥éª¤

1. å®¹å™¨å…³é—­ã€

2. å‘å¸ƒContextCLosedEventäº‹ä»¶

3. è°ƒç”¨lifecycleProcessorçš„OnClosedæ–¹æ³•

4. é”€æ¯å•ä¾‹Bean

   1. æ‰¾å‡ºæ‰€æœ‰DisposableBean(å®ç°äº†DisposableBeanæ¥å£çš„Bean)

   2. éå†æ¯ä¸ªDisposableBean

   3. æ‰¾å‡ºä¾èµ–äº†å½“å‰DisposableBeançš„å…¶ä»–Beanï¼Œå°†è¿™äº›Beanä»å•ä¾‹æ± ä¸­ç§»é™¤æ‰

   4. è°ƒç”¨DisposableBeançš„destroy()æ–¹æ³•

   5. æ‰¾åˆ°å½“å‰DisposableBeanæ‰€åŒ…å«çš„inner beansï¼Œå°†è¿™äº›Beanä»å•ä¾‹æ± ä¸­ç§»é™¤æ‰ 
   
    è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼
    
    
---
*[ğŸ‘ˆ 0000 Javaç›®å½•](../../0000Javaç›®å½•.md)*

*[415 å‡ºå“ï¼Œå¿…å±ç²¾å“](../../../note.md)*